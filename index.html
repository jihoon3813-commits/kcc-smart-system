<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KCC GLASS ì ‘ìˆ˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f3f4f6; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px; }
        .btn-primary { background: #1e3a8a; color: white; width: 100%; padding: 16px; border-radius: 12px; font-weight: bold; }
    </style>
</head>
<body class="p-4 pb-20 max-w-md mx-auto">
    <h1 class="text-xl font-bold mb-6 text-blue-900">KCC GLASS ì‹¤ì¸¡ ì ‘ìˆ˜</h1>

    <div class="bg-white p-5 rounded-xl shadow-sm mb-4">
        <h3 class="font-bold mb-3">ğŸ‘¤ ê³ ê° ì •ë³´</h3>
        <input type="text" id="customerName" placeholder="ê³ ê° ì„±í•¨">
        <input type="tel" id="customerPhone" placeholder="ì—°ë½ì²˜ (ìˆ«ìë§Œ)" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
    </div>

    <div class="bg-white p-5 rounded-xl shadow-sm mb-4">
        <h3 class="font-bold mb-3">ğŸ  í˜„ì¥ ì •ë³´</h3>
        <div class="flex gap-2 mb-2">
            <input type="text" id="postcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly class="bg-gray-50">
            <button onclick="openPostcode()" class="bg-blue-600 text-white px-4 rounded-lg text-sm font-bold whitespace-nowrap h-[50px]">ê²€ìƒ‰</button>
        </div>
        <input type="text" id="roadAddress" placeholder="ì£¼ì†Œ (ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”)" readonly class="bg-gray-50" onclick="openPostcode()">
        <input type="text" id="detailAddress" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥">
        
        <p class="text-sm font-bold mt-2 mb-1">í™•ì¥ ì—¬ë¶€</p>
        <div class="flex gap-2 mb-3">
            <label class="flex-1"><input type="radio" name="ext" value="í™•ì¥" checked> í™•ì¥</label>
            <label class="flex-1"><input type="radio" name="ext" value="ë¹„í™•ì¥"> ë¹„í™•ì¥</label>
        </div>
        <textarea id="memo" placeholder="íŠ¹ì´ì‚¬í•­ ë©”ëª¨" class="h-20"></textarea>
    </div>

    <div class="bg-white p-5 rounded-xl shadow-sm mb-4">
        <h3 class="font-bold mb-3">ğŸªŸ ì°½í˜¸ ì‚¬ì´ì¦ˆ</h3>
        <div id="windowList" class="space-y-4"></div>
        <button onclick="addWindow()" class="w-full py-3 border-2 border-dashed border-blue-300 text-blue-600 rounded-xl font-bold mt-4">+ ì°½í˜¸ ì¶”ê°€</button>
    </div>

    <button onclick="submitData()" class="btn-primary shadow-lg">ê²¬ì  ìš”ì²­í•˜ê¸°</button>

    <div id="loading" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center text-white font-bold">ì „ì†¡ ì¤‘...</div>

    <script>
        // â–¼â–¼â–¼ ì—¬ê¸°ì— URL ë¶™ì—¬ë„£ê¸° â–¼â–¼â–¼
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwjmu1V8U7qdtGq-o6Qed23SdNAUvGQ8udLKo5BOmgz1DLu7uOHGHUv7K_-3MvtEpKR/exec"; 

        const locs = ["ê±°ì‹¤ ë² ë€ë‹¤(ì™¸ì°½)","ê±°ì‹¤ ë¶„í•©ë¬¸","ì•ˆë°© ë² ë€ë‹¤(ì™¸ì°½)","ì•ˆë°© ë‚´ì°½(ë‹¨ì°½)","ì•ˆë°© ë‚´ì°½(ì´ì¤‘ì°½)","ì‘ì€ë°©1(ì™¸ì°½)","ì‘ì€ë°©1(ë‚´ì°½)","ì‘ì€ë°©2(ì™¸ì°½)","ì‘ì€ë°©2(ë‚´ì°½)","ì£¼ë°© ë² ë€ë‹¤(ì™¸ì°½)","ì£¼ë°© ë² ë€ë‹¤(ë‚´ì°½)","ì£¼ë°© í„°ë‹ë„ì–´","ê±°ì‹¤ í„°ë‹ë„ì–´","ê¸°íƒ€(ì§ì ‘ì…ë ¥)"];

        window.onload = addWindow;

        function openPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    let addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                    if(data.buildingName && data.userSelectedType === 'R') addr += ' (' + data.buildingName + ')';
                    document.getElementById('postcode').value = data.zonecode;
                    document.getElementById('roadAddress').value = addr;
                    document.getElementById('detailAddress').focus();
                }
            }).open();
        }

        function addWindow() {
            const id = Date.now();
            const opts = locs.map(l => `<option value="${l}">${l}</option>`).join('');
            const html = `
                <div class="border p-3 rounded-lg relative bg-gray-50 win-card" id="card-${id}">
                    <button onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-500 font-bold">X</button>
                    <select class="mb-2 loc-select" onchange="toggleEtc('${id}', this.value)">${opts}</select>
                    <input type="text" id="etc-${id}" class="hidden mb-2" placeholder="ìœ„ì¹˜ ì§ì ‘ ì…ë ¥">
                    <div class="flex gap-2">
                        <input type="number" class="w-input" placeholder="ê°€ë¡œ(mm)">
                        <input type="number" class="h-input" placeholder="ì„¸ë¡œ(mm)">
                    </div>
                    <input type="file" accept="image/*" class="photo-input text-sm">
                </div>`;
            document.getElementById('windowList').insertAdjacentHTML('beforeend', html);
        }

        function toggleEtc(id, val) {
            const el = document.getElementById(`etc-${id}`);
            val === "ê¸°íƒ€(ì§ì ‘ì…ë ¥)" ? el.classList.remove('hidden') : el.classList.add('hidden');
        }

        async function submitData() {
            if(APPS_SCRIPT_URL.includes("ì—¬ê¸°ì—")) return alert("URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”.");
            
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            const addr = document.getElementById('roadAddress').value;
            if(!name || !phone || !addr) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            document.getElementById('loading').classList.remove('hidden');

            const wins = [];
            for (const card of document.querySelectorAll('.win-card')) {
                let loc = card.querySelector('.loc-select').value;
                if(loc.includes("ê¸°íƒ€")) loc = card.querySelector('input[id^="etc"]').value;
                
                const file = card.querySelector('.photo-input').files[0];
                let pData = null, pName = null, pType = null;
                
                if(file) {
                    pData = await new Promise(r => { const rd=new FileReader(); rd.onload=()=>r(rd.result); rd.readAsDataURL(file); });
                    pName = file.name; pType = file.type;
                }

                wins.push({
                    location: loc, 
                    width: card.querySelector('.w-input').value, 
                    height: card.querySelector('.h-input').value,
                    photoData: pData, photoName: pName, photoMimeType: pType
                });
            }

            const payload = {
                customerName: name, customerPhone: phone, 
                address: addr + " " + document.getElementById('detailAddress').value,
                extension: document.querySelector('input[name="ext"]:checked').value,
                memo: document.getElementById('memo').value,
                windows: wins
            };

            fetch(APPS_SCRIPT_URL, {
                method: "POST",
                redirect: "follow",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').classList.add('hidden');
                if(data.result === 'success') { alert("ì ‘ìˆ˜ ì™„ë£Œ!"); location.reload(); }
                else alert("ì˜¤ë¥˜: " + data.error);
            })
            .catch(err => {
                document.getElementById('loading').classList.add('hidden');
                alert("ì „ì†¡ ì‹¤íŒ¨. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
            });
        }
    </script>
</body>
</html>