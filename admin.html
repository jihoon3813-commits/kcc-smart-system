<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>KCC GLASS ë„ë©´ ì„¤ê³„ ì‹œìŠ¤í…œ (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>
        body { font-family: 'Pretendard', sans-serif; overflow: hidden; user-select: none; }
        .canvas-btn { @apply bg-white text-gray-700 p-2 rounded shadow border hover:bg-gray-50 active:bg-gray-100 transition; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <header class="bg-slate-900 text-white h-14 flex items-center justify-between px-6 shadow-md z-20">
        <h1 class="text-lg font-bold tracking-wider">KCC GLASS | ë„ë©´ ì„¤ê³„ Pro</h1>
        <div class="flex gap-3">
            <button onclick="loadData()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-2">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="downloadImage()" class="bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-2">ğŸ’¾ ë„ë©´ ì €ì¥</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-80 bg-white border-r flex flex-col z-10 shadow-xl">
            <div class="p-4 border-b bg-gray-50"><h2 class="font-bold text-gray-800">ğŸ“‹ ê³ ê° ì ‘ìˆ˜ í˜„í™©</h2></div>
            <div id="customerList" class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50">
                <div class="text-center text-gray-400 mt-10 text-xs">ë°ì´í„° ë¡œë”© í•„ìš”</div>
            </div>
            <div class="p-4 border-t bg-white">
                <label class="block text-xs font-bold text-gray-700 mb-2">ë„ë©´ ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
                <input type="file" id="bgUpload" accept="image/*" class="block w-full text-xs text-slate-500 file:mr-2 file:py-2 file:px-3 file:rounded border file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"/>
            </div>
        </div>

        <div class="flex-1 bg-gray-200 relative overflow-hidden flex items-center justify-center">
            <canvas id="canvas" class="bg-gray-300 shadow-2xl cursor-crosshair"></canvas>
            <div class="absolute bottom-6 right-6 flex flex-col gap-2">
                <button onclick="resetView()" class="canvas-btn">â†º</button>
                <button onclick="zoom(0.1)" class="canvas-btn">â•</button>
                <button onclick="zoom(-0.1)" class="canvas-btn">â–</button>
            </div>
            <div id="placeholder" class="absolute pointer-events-none text-center opacity-50">
                <p class="text-4xl mb-2">ğŸ—ï¸</p><p class="font-bold text-gray-600">ë„ë©´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</p>
            </div>
        </div>
    </div>

    <script>
        // â˜… ë°°í¬ëœ Apps Script URL ì…ë ¥ â˜…
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwvrgTOG_An2BzvDyu-YWTnfC69KO7okJ8od2sfCS0-2wyeg364AGcsFQcTbhvKHPV7eg/exec"; 
        
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let customers = {}, items = [], bgImage = new Image(), isBgLoaded = false;
        let scale = 1, panX = 0, panY = 0;
        let dragTarget = null, selectedItemIndex = -1, lastMouseX, lastMouseY;

        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            draw();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // [ê¸°ëŠ¥] ì „í™”ë²ˆí˜¸ í•˜ì´í”ˆ í¬ë§·íŒ… í•¨ìˆ˜
        function formatPhoneNumber(str) {
            if (!str) return "";
            return str.replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`);
        }

        function loadData() {
            const list = document.getElementById('customerList');
            list.innerHTML = '<div class="text-center py-4"><div class="animate-spin inline-block w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full"></div></div>';
            
            fetch(`${APPS_SCRIPT_URL}?op=read`)
                .then(res => res.json())
                .then(data => { customers = data; renderCustomerList(); })
                .catch(err => { list.innerHTML = '<p class="text-center text-red-500 text-xs mt-4">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</p>'; });
        }

        function renderCustomerList() {
            const container = document.getElementById('customerList');
            container.innerHTML = "";
            const ids = Object.keys(customers).sort().reverse();
            if(ids.length === 0) { container.innerHTML = '<p class="text-center text-gray-400 text-xs mt-4">ë°ì´í„° ì—†ìŒ</p>'; return; }

            ids.forEach(id => {
                const c = customers[id];
                // ì—¬ê¸°ì„œ ì „í™”ë²ˆí˜¸ í¬ë§·íŒ… ì ìš©
                const formattedPhone = formatPhoneNumber(c.phone);

                const div = document.createElement('div');
                div.className = "p-3 mb-2 bg-white border rounded hover:border-blue-500 cursor-pointer shadow-sm transition group";
                div.onclick = () => loadCustomerToCanvas(id);
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-sm text-gray-800">${c.name}</span>
                        <span class="text-[10px] text-gray-500">${formattedPhone}</span>
                    </div>
                    <div class="text-xs text-gray-500 truncate mb-1">ğŸ“ ${c.address}</div>
                    <div class="flex justify-between items-end">
                        <span class="text-[10px] text-gray-400">${new Date(c.timestamp).toLocaleDateString()}</span>
                        <span class="text-[10px] text-blue-600 font-bold bg-blue-50 px-1.5 py-0.5 rounded">ì°½í˜¸ ${c.windows.length}ê°œ</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function loadCustomerToCanvas(id) {
            const data = customers[id];
            items = data.windows.map((win, idx) => ({
                id: idx, location: win.location, size: `${win.width} x ${win.height}`,
                dotX: isBgLoaded ? bgImage.width / 2 : 400, dotY: isBgLoaded ? bgImage.height / 2 : 300,
                boxX: 50 + (idx % 3) * 220, boxY: 50 + Math.floor(idx / 3) * 100, boxW: 200, boxH: 70, color: "#1e3a8a"
            }));
            alert(`[${data.name}] ë‹˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.\në„ë©´ ìœ„ì— ë¹¨ê°„ ì ì„ ë°°ì¹˜í•˜ì„¸ìš”.`);
            draw();
        }

        document.getElementById('bgUpload').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                bgImage.src = evt.target.result;
                bgImage.onload = () => { isBgLoaded = true; document.getElementById('placeholder').style.display = 'none'; resetView(); }
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        function resetView() { scale = 1; panX = isBgLoaded ? (canvas.width - bgImage.width) / 2 : 0; panY = isBgLoaded ? (canvas.height - bgImage.height) / 2 : 0; draw(); }
        function zoom(amt) { const newScale = Math.max(0.2, Math.min(5, scale + amt)); const cx = canvas.width/2, cy = canvas.height/2; panX = cx - (cx - panX)*(newScale/scale); panY = cy - (cy - panY)*(newScale/scale); scale = newScale; draw(); }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#e5e7eb"; ctx.fillRect(0,0, canvas.width, canvas.height);
            
            ctx.save(); ctx.translate(panX, panY); ctx.scale(scale, scale);
            if (isBgLoaded) { ctx.shadowColor = "rgba(0,0,0,0.2)"; ctx.shadowBlur = 20; ctx.drawImage(bgImage, 0, 0); ctx.shadowBlur = 0; }
            items.forEach(it => { ctx.beginPath(); ctx.arc(it.dotX, it.dotY, 8/scale, 0, Math.PI*2); ctx.fillStyle = "rgba(239, 68, 68, 0.9)"; ctx.fill(); ctx.strokeStyle = "white"; ctx.lineWidth = 2/scale; ctx.stroke(); });
            ctx.restore();

            items.forEach(it => {
                const dx = it.dotX * scale + panX, dy = it.dotY * scale + panY;
                ctx.beginPath(); ctx.moveTo(dx, dy); ctx.lineTo(it.boxX + it.boxW/2, it.boxY + it.boxH/2);
                ctx.strokeStyle = it.color; ctx.lineWidth = 2; ctx.setLineDash([5, 3]); ctx.stroke(); ctx.setLineDash([]);
                
                ctx.shadowColor = "rgba(0,0,0,0.2)"; ctx.shadowBlur = 6; ctx.shadowOffsetY = 3;
                ctx.fillStyle = "white"; ctx.beginPath(); ctx.roundRect(it.boxX, it.boxY, it.boxW, it.boxH, 8); ctx.fill();
                ctx.shadowColor = "transparent"; ctx.lineWidth = 2; ctx.strokeStyle = (selectedItemIndex === it.id) ? "#ef4444" : it.color; ctx.stroke();
                
                ctx.fillStyle = it.color; ctx.font = "bold 14px Pretendard"; ctx.fillText(it.location, it.boxX + 12, it.boxY + 25);
                ctx.fillStyle = "#6b7280"; ctx.font = "12px Pretendard"; ctx.fillText(it.size, it.boxX + 12, it.boxY + 45);
            });
            ctx.fillStyle = "rgba(30, 58, 138, 0.8)"; ctx.font = "bold 16px Pretendard"; ctx.fillText("KCC GLASS | SMART PLAN", 20, canvas.height - 20);
        }

        function getMousePos(e) { const r = canvas.getBoundingClientRect(); return { x: e.clientX - r.left, y: e.clientY - r.top }; }
        function hitTest(x, y) {
            for (let i = items.length - 1; i >= 0; i--) { if (x>=items[i].boxX && x<=items[i].boxX+items[i].boxW && y>=items[i].boxY && y<=items[i].boxY+items[i].boxH) return {type:'box', index:i}; }
            for (let i = items.length - 1; i >= 0; i--) { const dx = items[i].dotX*scale+panX, dy = items[i].dotY*scale+panY; if (Math.sqrt((x-dx)**2+(y-dy)**2)<15) return {type:'dot', index:i}; }
            return null;
        }

        canvas.addEventListener('mousedown', e => {
            const p = getMousePos(e), hit = hitTest(p.x, p.y); lastMouseX = p.x; lastMouseY = p.y;
            if (hit) { dragTarget = hit.type; selectedItemIndex = items[hit.index].id; items.push(items.splice(hit.index, 1)[0]); } 
            else { dragTarget = 'map'; selectedItemIndex = -1; } draw();
        });
        canvas.addEventListener('mousemove', e => {
            if (!dragTarget) return;
            const p = getMousePos(e), dx = p.x - lastMouseX, dy = p.y - lastMouseY; const cur = items[items.length-1];
            if (dragTarget === 'map') { panX += dx; panY += dy; } else if (dragTarget === 'box') { cur.boxX += dx; cur.boxY += dy; } else if (dragTarget === 'dot') { cur.dotX += dx/scale; cur.dotY += dy/scale; }
            lastMouseX = p.x; lastMouseY = p.y; draw();
        });
        canvas.addEventListener('mouseup', () => dragTarget = null);
        canvas.addEventListener('wheel', e => { e.preventDefault(); zoom(e.deltaY > 0 ? -0.1 : 0.1); }, {passive:false});

        function downloadImage() { 
            if(!isBgLoaded && items.length===0) return alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            const link = document.createElement('a'); link.download = `KCC_ì„¤ê³„ë„ë©´_${Date.now()}.png`; link.href = canvas.toDataURL(); link.click(); 
        }
    </script>
</body>
</html>