<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>KCC ë„ë©´ ì„¤ê³„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>body { font-family: 'Pretendard'; overflow: hidden; user-select: none; }</style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <header class="bg-slate-900 text-white h-14 flex items-center justify-between px-6 shadow-md z-20">
        <h1 class="font-bold">KCC GLASS Admin</h1>
        <div class="flex gap-2">
            <button onclick="loadData()" class="bg-blue-600 px-3 py-1 rounded text-sm font-bold">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="downloadImage()" class="bg-green-600 px-3 py-1 rounded text-sm font-bold">ğŸ’¾ ë„ë©´ì €ì¥</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-80 bg-white border-r flex flex-col z-10 shadow-xl">
            <div id="customerList" class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50"></div>
            <div class="p-4 border-t bg-white">
                <p class="text-xs font-bold mb-2">ë„ë©´ ì—…ë¡œë“œ</p>
                <input type="file" id="bgUpload" accept="image/*" class="w-full text-xs">
            </div>
        </div>

        <div class="flex-1 bg-gray-200 relative flex items-center justify-center overflow-hidden">
            <canvas id="canvas" class="bg-gray-300 shadow-2xl"></canvas>
            <div class="absolute bottom-5 right-5 flex flex-col gap-2">
                <button onclick="resetView()" class="bg-white p-2 rounded shadow">â†º</button>
                <button onclick="zoom(0.1)" class="bg-white p-2 rounded shadow">â•</button>
                <button onclick="zoom(-0.1)" class="bg-white p-2 rounded shadow">â–</button>
            </div>
            <div id="placeholder" class="absolute pointer-events-none text-gray-500 font-bold">ë„ë©´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</div>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼ ì—¬ê¸°ì— URL ë¶™ì—¬ë„£ê¸° â–¼â–¼â–¼
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwjmu1V8U7qdtGq-o6Qed23SdNAUvGQ8udLKo5BOmgz1DLu7uOHGHUv7K_-3MvtEpKR/exec"; 

        let customers = {}, items = [], bgImage = new Image(), isBgLoaded = false;
        let scale = 1, panX = 0, panY = 0;
        let dragTarget = null, selectedIdx = -1, lastX, lastY;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; draw(); }
        window.addEventListener('resize', resize); resize();

        // â˜…â˜…â˜… í•µì‹¬: ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ìˆ˜ì •ë¨ â˜…â˜…â˜…
        function loadData() {
            const list = document.getElementById('customerList');
            list.innerHTML = 'ë¡œë”©ì¤‘...';
            
            // ë‹¨ìˆœ GET ìš”ì²­ (í—¤ë” ì—†ìŒ)
            fetch(`${APPS_SCRIPT_URL}?op=read`)
                .then(res => res.json())
                .then(data => {
                    customers = data;
                    renderList();
                })
                .catch(err => {
                    list.innerHTML = `<div class="text-red-500 text-xs p-4">ë¡œë“œ ì‹¤íŒ¨<br>URLê³¼ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.<br><br>ì—ëŸ¬: ${err}</div>`;
                });
        }

        function renderList() {
            const list = document.getElementById('customerList');
            list.innerHTML = '';
            const ids = Object.keys(customers).sort().reverse();
            if(ids.length === 0) { list.innerHTML = 'ë°ì´í„° ì—†ìŒ'; return; }

            ids.forEach(id => {
                const c = customers[id];
                const div = document.createElement('div');
                div.className = "p-3 bg-white border rounded cursor-pointer hover:border-blue-500";
                div.onclick = () => loadToCanvas(id);
                div.innerHTML = `
                    <div class="font-bold text-sm">${c.name} <span class="text-gray-400 font-normal">${c.phone}</span></div>
                    <div class="text-xs text-gray-500 truncate">${c.address}</div>
                    <div class="text-xs text-blue-600 font-bold mt-1">ì°½í˜¸ ${c.windows.length}ê°œ</div>
                `;
                list.appendChild(div);
            });
        }

        function loadToCanvas(id) {
            const data = customers[id];
            items = data.windows.map((w, i) => ({
                id: i, loc: w.location, size: `${w.width}x${w.height}`,
                dx: isBgLoaded ? bgImage.width/2 : 400, dy: isBgLoaded ? bgImage.height/2 : 300,
                bx: 50 + (i%3)*220, by: 50 + Math.floor(i/3)*100, bw: 200, bh: 70, col: "#1e3a8a"
            }));
            alert(`${data.name}ë‹˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
            draw();
        }

        document.getElementById('bgUpload').addEventListener('change', e => {
            const rd = new FileReader();
            rd.onload = ev => { bgImage.src = ev.target.result; bgImage.onload = () => { isBgLoaded=true; document.getElementById('placeholder').style.display='none'; resetView(); }};
            rd.readAsDataURL(e.target.files[0]);
        });

        function resetView() { scale=1; panX=isBgLoaded?(canvas.width-bgImage.width)/2:0; panY=isBgLoaded?(canvas.height-bgImage.height)/2:0; draw(); }
        function zoom(v) { scale = Math.max(0.2, Math.min(5, scale+v)); draw(); }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save(); ctx.translate(panX, panY); ctx.scale(scale, scale);
            if(isBgLoaded) ctx.drawImage(bgImage, 0, 0);
            
            // ì  ê·¸ë¦¬ê¸°
            items.forEach(it => {
                ctx.beginPath(); ctx.arc(it.dx, it.dy, 8/scale, 0, Math.PI*2);
                ctx.fillStyle = "red"; ctx.fill(); ctx.stroke();
            });
            ctx.restore();

            // ë°•ìŠ¤ ê·¸ë¦¬ê¸°
            items.forEach(it => {
                // ì„  ì—°ê²°
                const sx = it.dx*scale+panX, sy = it.dy*scale+panY;
                ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(it.bx+it.bw/2, it.by+it.bh/2);
                ctx.strokeStyle = it.col; ctx.setLineDash([5,3]); ctx.stroke(); ctx.setLineDash([]);

                // ë°•ìŠ¤
                ctx.fillStyle="white"; ctx.fillRect(it.bx, it.by, it.bw, it.bh);
                ctx.strokeStyle= (selectedIdx===it.id)?"red":it.col; ctx.strokeRect(it.bx, it.by, it.bw, it.bh);
                
                ctx.fillStyle=it.col; ctx.font="bold 14px sans-serif"; ctx.fillText(it.loc, it.bx+10, it.by+25);
                ctx.fillStyle="#666"; ctx.font="12px sans-serif"; ctx.fillText(it.size, it.bx+10, it.by+45);
            });
        }

        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
        function getPos(e) { const r = canvas.getBoundingClientRect(); return { x: e.clientX-r.left, y: e.clientY-r.top }; }
        canvas.addEventListener('mousedown', e => {
            const p = getPos(e); lastX=p.x; lastY=p.y;
            // ë°•ìŠ¤ ì²´í¬
            for(let i=items.length-1; i>=0; i--) {
                const it=items[i];
                if(p.x>=it.bx && p.x<=it.bx+it.bw && p.y>=it.by && p.y<=it.by+it.bh) { dragTarget='box'; selectedIdx=it.id; items.push(items.splice(i,1)[0]); draw(); return; }
            }
            // ì  ì²´í¬
            for(let i=items.length-1; i>=0; i--) {
                const it=items[i], dx=it.dx*scale+panX, dy=it.dy*scale+panY;
                if(Math.sqrt((p.x-dx)**2+(p.y-dy)**2) < 15) { dragTarget='dot'; selectedIdx=it.id; items.push(items.splice(i,1)[0]); draw(); return; }
            }
            dragTarget='map'; selectedIdx=-1;
        });

        canvas.addEventListener('mousemove', e => {
            if(!dragTarget) return;
            const p = getPos(e), dx = p.x-lastX, dy = p.y-lastY;
            const cur = items[items.length-1];
            if(dragTarget==='map') { panX+=dx; panY+=dy; }
            else if(dragTarget==='box') { cur.bx+=dx; cur.by+=dy; }
            else if(dragTarget==='dot') { cur.dx+=dx/scale; cur.dy+=dy/scale; }
            lastX=p.x; lastY=p.y; draw();
        });

        canvas.addEventListener('mouseup', () => dragTarget=null);
        canvas.addEventListener('wheel', e => { e.preventDefault(); zoom(e.deltaY>0?-0.1:0.1); }, {passive:false});

        function downloadImage() { 
            const a = document.createElement('a'); a.download='ë„ë©´.png'; a.href=canvas.toDataURL(); a.click(); 
        }
    </script>
</body>
</html>