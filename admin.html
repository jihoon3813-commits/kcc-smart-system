<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>KCC GLASS ë„ë©´ ì„¤ê³„ ì‹œìŠ¤í…œ (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>
        body { font-family: 'Pretendard', sans-serif; overflow: hidden; user-select: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* ìº”ë²„ìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬ ìŠ¤íƒ€ì¼ */
        .canvas-btn {
            @apply bg-white text-gray-700 p-2 rounded shadow border hover:bg-gray-50 active:bg-gray-100 transition;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <header class="bg-slate-900 text-white h-14 flex items-center justify-between px-6 shadow-md z-20">
        <div class="flex items-center gap-3">
            <h1 class="text-lg font-bold tracking-wider">KCC GLASS | ë„ë©´ ì„¤ê³„ Pro</h1>
        </div>
        <div class="flex gap-3">
            <button onclick="loadData()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-2">
                <span>ğŸ”„ ì ‘ìˆ˜í˜„í™© ìƒˆë¡œê³ ì¹¨</span>
            </button>
            <button onclick="downloadImage()" class="bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-2">
                <span>ğŸ’¾ ì„¤ê³„ë„ë©´ ì €ì¥</span>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-72 bg-white border-r flex flex-col z-10 shadow-xl">
            <div class="p-4 border-b bg-gray-50">
                <h2 class="font-bold text-gray-800">ğŸ“‹ ëŒ€ê¸°ì¤‘ì¸ ê³ ê°</h2>
            </div>
            <div id="customerList" class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50">
                <div class="text-center text-gray-400 mt-10 text-xs">ë°ì´í„° ë¡œë”© í•„ìš”</div>
            </div>
            
            <div class="p-4 border-t bg-white">
                <label class="block text-xs font-bold text-gray-700 mb-2"> ë°°ê²½ ë„ë©´ ì—…ë¡œë“œ</label>
                <input type="file" id="bgUpload" accept="image/*" class="block w-full text-xs text-slate-500 file:mr-2 file:py-2 file:px-3 file:rounded border file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"/>
                <p class="text-[10px] text-gray-400 mt-2">* ë§ˆìš°ìŠ¤ íœ : í™•ëŒ€/ì¶•ì†Œ <br>* ë°”íƒ• ë“œë˜ê·¸: ë„ë©´ ì´ë™</p>
            </div>
        </div>

        <div class="flex-1 bg-gray-200 relative overflow-hidden flex items-center justify-center">
            
            <canvas id="canvas" class="bg-gray-300 shadow-2xl cursor-crosshair"></canvas>

            <div class="absolute bottom-6 right-6 flex flex-col gap-2">
                <button onclick="resetView()" class="canvas-btn" title="í™”ë©´ ì´ˆê¸°í™”">â†º</button>
                <button onclick="zoom(0.1)" class="canvas-btn" title="í™•ëŒ€">â•</button>
                <button onclick="zoom(-0.1)" class="canvas-btn" title="ì¶•ì†Œ">â–</button>
            </div>

            <div id="placeholder" class="absolute pointer-events-none text-center opacity-50">
                <p class="text-4xl mb-2">ğŸ—ï¸</p>
                <p class="font-bold text-gray-600">ë„ë©´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</p>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // â˜… ì„¤ì •: ë°°í¬ëœ Apps Script URL ì…ë ¥ â˜…
        // ==========================================
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwvrgTOG_An2BzvDyu-YWTnfC69KO7okJ8od2sfCS0-2wyeg364AGcsFQcTbhvKHPV7eg/exec"; 
        
        // ------------------------------------------

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // ìƒíƒœ ë³€ìˆ˜
        let customers = {};
        let items = []; // í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë§ˆì»¤ë“¤ {dotX, dotY, boxX, boxY, ...}
        let bgImage = new Image();
        let isBgLoaded = false;

        // ë·°í¬íŠ¸ ìƒíƒœ (Zoom/Pan)
        let scale = 1;
        let panX = 0;
        let panY = 0;
        
        // ë“œë˜ê·¸ ìƒíƒœ
        let isDraggingMap = false;
        let dragTarget = null; // 'map', 'dot', 'box'
        let selectedItemIndex = -1;
        let lastMouseX, lastMouseY;

        // ìº”ë²„ìŠ¤ í¬ê¸° ì „ì²´í™”ë©´ ì„¤ì •
        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            draw();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ==========================================
        // 1. ë°ì´í„° ë¡œë“œ ë° ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬
        // ==========================================
        function loadData() {
            const listContainer = document.getElementById('customerList');
            listContainer.innerHTML = '<div class="text-center py-4"><div class="animate-spin inline-block w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full"></div></div>';

            fetch(`${APPS_SCRIPT_URL}?op=read`)
                .then(res => res.json())
                .then(data => {
                    customers = data;
                    renderCustomerList();
                })
                .catch(err => {
                    alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
                    listContainer.innerHTML = '<p class="text-center text-red-500 text-xs mt-4">ì—°ê²° ì‹¤íŒ¨</p>';
                });
        }

        function renderCustomerList() {
            const container = document.getElementById('customerList');
            container.innerHTML = "";
            const ids = Object.keys(customers).sort().reverse();

            if(ids.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 text-xs mt-4">ë°ì´í„° ì—†ìŒ</p>';
                return;
            }

            ids.forEach(id => {
                const c = customers[id];
                const div = document.createElement('div');
                div.className = "p-3 mb-2 bg-white border rounded hover:border-blue-500 cursor-pointer shadow-sm transition group";
                div.onclick = () => loadCustomerToCanvas(id);
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-sm text-gray-800">${c.name}</span>
                        <span class="text-[10px] text-gray-400">${new Date(c.timestamp).toLocaleDateString()}</span>
                    </div>
                    <div class="text-xs text-gray-500 truncate">${c.address}</div>
                    <div class="mt-1 text-[10px] text-blue-600 font-bold">ì°½í˜¸ ${c.windows.length}ê°œ</div>
                `;
                container.appendChild(div);
            });
        }

        function loadCustomerToCanvas(id) {
            const data = customers[id];
            
            // ì•„ì´í…œ ì´ˆê¸°í™”
            // dotX, dotY: ì´ë¯¸ì§€ ê¸°ì¤€ ì¢Œí‘œ (Zoomì‹œ ë”°ë¼ë‹¤ë‹˜)
            // boxX, boxY: ìº”ë²„ìŠ¤ ê¸°ì¤€ ì¢Œí‘œ (í™”ë©´ì— ê³ ì •ëœ ëŠë‚Œìœ¼ë¡œ ì‹œì‘í•˜ë˜ ë“œë˜ê·¸ ê°€ëŠ¥)
            items = data.windows.map((win, idx) => ({
                id: idx,
                location: win.location,
                size: `${win.width} x ${win.height}`,
                // ì´ˆê¸° ìœ„ì¹˜: ì ì€ ì´ë¯¸ì§€ ì¤‘ì•™, ë°•ìŠ¤ëŠ” ìš°ì¸¡ì— ë‚˜ì—´
                dotX: isBgLoaded ? bgImage.width / 2 : 400,
                dotY: isBgLoaded ? bgImage.height / 2 : 300,
                boxX: 50 + (idx % 3) * 220, // í™”ë©´ ì¢Œì¸¡ ìƒë‹¨ë¶€í„° ë°°ì¹˜
                boxY: 50 + Math.floor(idx / 3) * 100,
                boxW: 200, boxH: 70,
                color: "#1e3a8a"
            }));
            
            alert(`[${data.name}] ê³ ê°ë‹˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.\n1. ë¹¨ê°„ ì ì„ ë„ë©´ ìœ„ ì°½í˜¸ ìœ„ì¹˜ë¡œ ì˜®ê¸°ì„¸ìš”.\n2. ì„¤ëª… ë°•ìŠ¤ë¥¼ ë³´ê¸° ì¢‹ì€ ê³³ìœ¼ë¡œ ì •ë¦¬í•˜ì„¸ìš”.`);
            draw();
        }

        // ==========================================
        // 2. ë„ë©´ ì—…ë¡œë“œ ë° ì œì–´
        // ==========================================
        document.getElementById('bgUpload').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                bgImage.src = evt.target.result;
                bgImage.onload = () => {
                    isBgLoaded = true;
                    document.getElementById('placeholder').style.display = 'none';
                    // ì´ë¯¸ì§€ ë¡œë“œ ì‹œ ë·° ë¦¬ì…‹ (ì¤‘ì•™ ì •ë ¬)
                    resetView();
                }
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        function resetView() {
            scale = 1;
            // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í™”ë©´ ì¤‘ì•™ì— ì˜¤ë„ë¡ pan ì„¤ì •
            if(isBgLoaded) {
                panX = (canvas.width - bgImage.width) / 2;
                panY = (canvas.height - bgImage.height) / 2;
            } else {
                panX = 0; panY = 0;
            }
            draw();
        }

        function zoom(amount) {
            const newScale = scale + amount;
            if(newScale > 0.1 && newScale < 5) {
                // í™”ë©´ ì¤‘ì•™ ê¸°ì¤€ìœ¼ë¡œ ì¤Œ
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                panX = centerX - (centerX - panX) * (newScale / scale);
                panY = centerY - (centerY - panY) * (newScale / scale);
                scale = newScale;
                draw();
            }
        }

        // ==========================================
        // 3. ê·¸ë¦¬ê¸° ì—”ì§„ (í•µì‹¬)
        // ==========================================
        function draw() {
            // í™”ë©´ í´ë¦¬ì–´
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#e5e7eb"; // ë°°ê²½ìƒ‰
            ctx.fillRect(0,0, canvas.width, canvas.height);

            // 1) ë„ë©´ ê·¸ë¦¬ê¸° (Zoom/Pan ì ìš©)
            ctx.save();
            ctx.translate(panX, panY);
            ctx.scale(scale, scale);

            if (isBgLoaded) {
                // ê·¸ë¦¼ì íš¨ê³¼
                ctx.shadowColor = "rgba(0,0,0,0.2)";
                ctx.shadowBlur = 20;
                ctx.drawImage(bgImage, 0, 0);
                ctx.shadowBlur = 0; // ë¦¬ì…‹
            }
            
            // 2) ë„ë©´ ìœ„ì˜ 'ì (Anchor)' ê·¸ë¦¬ê¸°
            // ì ì€ ë„ë©´ ì¢Œí‘œê³„(transformed)ë¥¼ ë”°ë¦„
            items.forEach(item => {
                ctx.beginPath();
                ctx.arc(item.dotX, item.dotY, 8 / scale, 0, Math.PI * 2); // ì¤Œì•„ì›ƒí•´ë„ ì  í¬ê¸°ëŠ” ì¼ì •í•˜ê²Œ ë³´ì´ë„ë¡ ë³´ì •
                ctx.fillStyle = "rgba(239, 68, 68, 0.9)"; // Red Color
                ctx.fill();
                ctx.strokeStyle = "white";
                ctx.lineWidth = 2 / scale;
                ctx.stroke();
            });

            ctx.restore(); // ì¢Œí‘œê³„ ë³µêµ¬ (ì´ì œë¶€í„° í™”ë©´ ì¢Œí‘œê³„)

            // 3) ì—°ê²°ì„  ë° ë°•ìŠ¤ ê·¸ë¦¬ê¸°
            items.forEach(item => {
                // ì ì˜ í˜„ì¬ í™”ë©´ìƒ ìœ„ì¹˜ ê³„ì‚°
                const dotScreenX = item.dotX * scale + panX;
                const dotScreenY = item.dotY * scale + panY;

                // ì—°ê²°ì„  ê·¸ë¦¬ê¸° (ì  -> ë°•ìŠ¤ ì¤‘ì•™)
                ctx.beginPath();
                ctx.moveTo(dotScreenX, dotScreenY);
                ctx.lineTo(item.boxX + item.boxW/2, item.boxY + item.boxH/2);
                ctx.strokeStyle = item.color;
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 3]); // ì ì„  íš¨ê³¼
                ctx.stroke();
                ctx.setLineDash([]); // ì‹¤ì„  ë³µêµ¬

                // ë°•ìŠ¤ ê·¸ë¦¬ê¸°
                // ê·¸ë¦¼ì
                ctx.shadowColor = "rgba(0,0,0,0.2)";
                ctx.shadowBlur = 6;
                ctx.shadowOffsetY = 3;

                ctx.fillStyle = "white";
                ctx.beginPath();
                ctx.roundRect(item.boxX, item.boxY, item.boxW, item.boxH, 8);
                ctx.fill();
                
                // ë°•ìŠ¤ í…Œë‘ë¦¬ (ì„ íƒ ì‹œ ê°•ì¡°)
                ctx.shadowColor = "transparent";
                ctx.lineWidth = 2;
                ctx.strokeStyle = (selectedItemIndex === item.id) ? "#ef4444" : item.color;
                ctx.stroke();

                // í…ìŠ¤íŠ¸
                ctx.fillStyle = item.color;
                ctx.font = "bold 14px Pretendard";
                ctx.fillText(item.location, item.boxX + 12, item.boxY + 25);
                
                ctx.fillStyle = "#6b7280";
                ctx.font = "12px Pretendard";
                ctx.fillText(item.size, item.boxX + 12, item.boxY + 45);
            });

            // 4) ì›Œí„°ë§ˆí¬
            drawWatermark();
        }

        function drawWatermark() {
            ctx.fillStyle = "rgba(30, 58, 138, 0.8)";
            ctx.font = "bold 16px Pretendard";
            ctx.fillText("KCC GLASS | SMART PLAN", 20, canvas.height - 20);
        }

        // ==========================================
        // 4. ë§ˆìš°ìŠ¤ ì¸í„°ë™ì…˜ (ë³µì¡ë„ ë†’ìŒ)
        // ==========================================
        
        // ë§ˆìš°ìŠ¤ ì¢Œí‘œ êµ¬í•˜ê¸°
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        // íˆíŠ¸ í…ŒìŠ¤íŠ¸ (ë¬´ì—‡ì„ í´ë¦­í–ˆë‚˜?)
        function hitTest(x, y) {
            // 1. ë°•ìŠ¤ í™•ì¸ (í™”ë©´ ì¢Œí‘œ)
            for (let i = items.length - 1; i >= 0; i--) {
                const it = items[i];
                if (x >= it.boxX && x <= it.boxX + it.boxW && y >= it.boxY && y <= it.boxY + it.boxH) {
                    return { type: 'box', index: i };
                }
            }
            // 2. ì  í™•ì¸ (í™”ë©´ ì¢Œí‘œë¡œ ë³€í™˜í•´ì„œ í™•ì¸)
            for (let i = items.length - 1; i >= 0; i--) {
                const it = items[i];
                const dotSx = it.dotX * scale + panX;
                const dotSy = it.dotY * scale + panY;
                const dist = Math.sqrt((x - dotSx)**2 + (y - dotSy)**2);
                if (dist < 15) { // ì  í´ë¦­ ë°˜ê²½
                    return { type: 'dot', index: i };
                }
            }
            return null;
        }

        canvas.addEventListener('mousedown', (e) => {
            const pos = getMousePos(e);
            const hit = hitTest(pos.x, pos.y);
            
            lastMouseX = pos.x;
            lastMouseY = pos.y;

            if (hit) {
                // ì•„ì´í…œ(ì  or ë°•ìŠ¤) í´ë¦­
                dragTarget = hit.type;
                selectedItemIndex = items[hit.index].id; // idë¡œ ë§¤ì¹­
                // ì„ íƒëœ ì•„ì´í…œì„ ë°°ì—´ ë§¨ ë’¤ë¡œ(í™”ë©´ ë§¨ ìœ„ë¡œ)
                const idx = hit.index;
                items.push(items.splice(idx, 1)[0]);
            } else {
                // ë¹ˆ ê³µê°„ í´ë¦­ -> ë„ë©´ ì´ë™(Pan)
                dragTarget = 'map';
                selectedItemIndex = -1;
            }
            draw();
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!dragTarget) return;
            const pos = getMousePos(e);
            const dx = pos.x - lastMouseX;
            const dy = pos.y - lastMouseY;

            const currentItem = items[items.length - 1]; // í˜„ì¬ ì„ íƒëœ ê±´ í•­ìƒ ë§¨ ë’¤

            if (dragTarget === 'map') {
                panX += dx;
                panY += dy;
            } else if (dragTarget === 'box') {
                currentItem.boxX += dx;
                currentItem.boxY += dy;
            } else if (dragTarget === 'dot') {
                // ì ì€ ë„ë©´ ì¢Œí‘œê³„ë¡œ ì—­ë³€í™˜í•˜ì—¬ ì €ì¥
                currentItem.dotX += dx / scale;
                currentItem.dotY += dy / scale;
            }

            lastMouseX = pos.x;
            lastMouseY = pos.y;
            draw();
        });

        canvas.addEventListener('mouseup', () => { dragTarget = null; });
        canvas.addEventListener('mouseout', () => { dragTarget = null; });

        // íœ  ì¤Œ (ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ê¸°ì¤€ í™•ëŒ€)
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const pos = getMousePos(e);
            const zoomIntensity = 0.1;
            const delta = e.deltaY > 0 ? -zoomIntensity : zoomIntensity;
            const newScale = Math.min(Math.max(0.2, scale + delta), 5); // 0.2ë°° ~ 5ë°° ì œí•œ

            // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ì¤Œ ê³„ì‚°
            panX = pos.x - (pos.x - panX) * (newScale / scale);
            panY = pos.y - (pos.y - panY) * (newScale / scale);
            scale = newScale;
            draw();
        }, { passive: false });


        // ==========================================
        // 5. ì´ë¯¸ì§€ ì €ì¥
        // ==========================================
        function downloadImage() {
            if(!isBgLoaded && items.length === 0) return alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            
            const link = document.createElement('a');
            link.download = `KCC_ì„¤ê³„ë„ë©´_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>