<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>KCC ë„ë©´ ì„¤ê³„ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>body { font-family: 'Pretendard'; overflow: hidden; user-select: none; }</style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <header class="bg-slate-900 text-white h-14 flex items-center justify-between px-6 shadow-md z-20">
        <div class="flex items-center gap-2">
            <h1 class="font-bold tracking-wider text-lg">KCC GLASS Admin</h1>
            <span class="text-xs bg-gray-700 px-2 py-1 rounded">Smart Plan v2.0</span>
        </div>
        <div class="flex gap-2">
            <button onclick="loadData()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-1">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="downloadHighResImage()" class="bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-1 shadow-lg border border-emerald-400">ğŸ’¾ ë„ë©´ ì €ì¥ (ê³ í™”ì§ˆ)</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-80 bg-white border-r flex flex-col z-10 shadow-xl">
            <div class="p-4 bg-blue-50 border-b border-blue-100">
                <h3 class="font-bold text-blue-900 text-sm mb-2">ğŸ‘¨â€ğŸ’¼ ìƒë‹´ì‚¬ ì •ë³´ (ëª…í•¨)</h3>
                <input type="text" id="consultantName" placeholder="ìƒë‹´ì‚¬ ì„±í•¨ (ì˜ˆ: ê¹€KCC)" class="w-full text-sm p-2 border rounded mb-2">
                <input type="text" id="consultantPhone" placeholder="ì—°ë½ì²˜ (ì˜ˆ: 010-0000-0000)" class="w-full text-sm p-2 border rounded">
                <p class="text-[10px] text-gray-400 mt-1">* ë„ë©´ ì €ì¥ ì‹œ í•˜ë‹¨ì— í•©ì„±ë©ë‹ˆë‹¤.</p>
            </div>

            <div class="p-3 bg-gray-50 border-b"><h2 class="font-bold text-gray-700 text-sm">ğŸ“‹ ê³ ê° ì ‘ìˆ˜ ëª©ë¡</h2></div>
            <div id="customerList" class="flex-1 overflow-y-auto p-2 space-y-2 bg-white"></div>
            
            <div class="p-4 border-t bg-gray-50">
                <label class="block text-xs font-bold text-gray-700 mb-2">ë°°ê²½ ë„ë©´ ì—…ë¡œë“œ</label>
                <input type="file" id="bgUpload" accept="image/*" class="w-full text-xs text-gray-500 file:mr-2 file:py-2 file:px-3 file:rounded border file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white cursor-pointer"/>
            </div>
        </div>

        <div class="flex-1 bg-gray-200 relative flex items-center justify-center overflow-hidden">
            <canvas id="canvas" class="bg-gray-300 shadow-2xl cursor-crosshair"></canvas>
            
            <div class="absolute bottom-6 right-6 flex flex-col gap-2 shadow-lg">
                <button onclick="resetView()" class="bg-white p-2 rounded hover:bg-gray-50 border">â†º</button>
                <button onclick="zoom(0.1)" class="bg-white p-2 rounded hover:bg-gray-50 border">â•</button>
                <button onclick="zoom(-0.1)" class="bg-white p-2 rounded hover:bg-gray-50 border">â–</button>
            </div>
            
            <div id="placeholder" class="absolute pointer-events-none text-center opacity-40">
                <p class="text-4xl mb-2">ğŸ—ï¸</p><p class="font-bold text-gray-600">ë„ë©´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</p>
            </div>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜… ë°°í¬ëœ Apps Script URLì„ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš” â˜…â˜…â˜…
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwjmu1V8U7qdtGq-o6Qed23SdNAUvGQ8udLKo5BOmgz1DLu7uOHGHUv7K_-3MvtEpKR/exec"; 

        let customers = {}, items = [], bgImage = new Image(), isBgLoaded = false;
        let scale = 1, panX = 0, panY = 0;
        let dragTarget = null, selectedIdx = -1, lastX, lastY;
        
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; draw(); }
        window.addEventListener('resize', resize); resize();

        // ì „í™”ë²ˆí˜¸ í•˜ì´í”ˆ ìë™ í¬ë§·íŒ…
        function formatPhone(str) {
            if(!str) return "";
            return str.replace(/[^0-9]/g, '').replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`);
        }

        // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (GET)
        function loadData() {
            const list = document.getElementById('customerList');
            list.innerHTML = '<div class="text-center py-4 text-sm text-gray-500">ë¡œë”©ì¤‘...</div>';
            
            fetch(`${APPS_SCRIPT_URL}?op=read`, { method: "GET" })
                .then(res => { if(!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜"); return res.json(); })
                .then(data => { customers = data; renderList(); })
                .catch(err => {
                    list.innerHTML = `<div class="text-red-500 text-xs p-4 text-center">ë¡œë“œ ì‹¤íŒ¨<br>${err.message}</div>`;
                });
        }

        function renderList() {
            const list = document.getElementById('customerList');
            list.innerHTML = '';
            const ids = Object.keys(customers).sort().reverse();
            if(ids.length === 0) { list.innerHTML = '<div class="text-center py-4 text-sm text-gray-400">ë°ì´í„° ì—†ìŒ</div>'; return; }

            ids.forEach(id => {
                const c = customers[id];
                const div = document.createElement('div');
                div.className = "p-3 bg-white border rounded hover:border-blue-500 cursor-pointer shadow-sm mb-2 group transition";
                div.onclick = () => loadToCanvas(id);
                div.innerHTML = `
                    <div class="flex justify-between mb-1">
                        <span class="font-bold text-sm text-gray-800">${c.name}</span>
                        <span class="text-xs text-gray-500 font-mono">${formatPhone(c.phone)}</span>
                    </div>
                    <div class="text-xs text-gray-500 truncate mb-2">ğŸ“ ${c.address}</div>
                    <div class="flex justify-between items-end">
                        <span class="text-[10px] text-gray-400">${new Date(c.timestamp).toLocaleDateString()}</span>
                        <span class="text-[10px] bg-blue-50 text-blue-700 px-2 py-0.5 rounded font-bold">ì°½í˜¸ ${c.windows.length}ea</span>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function loadToCanvas(id) {
            const data = customers[id];
            // ë°•ìŠ¤ ì´ˆê¸° ìœ„ì¹˜ë¥¼ "í™”ë©´ ì¤‘ì•™"ì´ ì•„ë‹ˆë¼ "ì´ë¯¸ì§€ ì¤‘ì•™" ê·¼ì²˜ë¡œ ë°°ì¹˜
            const startX = isBgLoaded ? bgImage.width/2 : 400;
            const startY = isBgLoaded ? bgImage.height/2 : 300;

            items = data.windows.map((w, i) => ({
                id: i, loc: w.location, size: `${w.width}x${w.height}`,
                dx: startX, dy: startY, // ì  ìœ„ì¹˜ (ì´ë¯¸ì§€ ê¸°ì¤€)
                // ë°•ìŠ¤ ìœ„ì¹˜ (ì´ë¯¸ì§€ ê¸°ì¤€ ì¢Œí‘œê³„ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥)
                bx: startX + 50 + (i%2)*220, 
                by: startY - 100 + Math.floor(i/2)*80, 
                bw: 200, bh: 65, col: "#1e3a8a"
            }));
            alert(`${data.name} ê³ ê°ë‹˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.\nì ê³¼ ë°•ìŠ¤ë¥¼ ë„ë©´ì— ë§ê²Œ ë°°ì¹˜í•´ì£¼ì„¸ìš”.`);
            draw();
        }

        document.getElementById('bgUpload').addEventListener('change', e => {
            const rd = new FileReader();
            rd.onload = ev => { bgImage.src = ev.target.result; bgImage.onload = () => { isBgLoaded=true; document.getElementById('placeholder').style.display='none'; resetView(); }};
            rd.readAsDataURL(e.target.files[0]);
        });

        function resetView() { scale=1; panX=isBgLoaded?(canvas.width-bgImage.width)/2:0; panY=isBgLoaded?(canvas.height-bgImage.height)/2:0; draw(); }
        function zoom(v) { 
            const newScale = Math.max(0.1, Math.min(5, scale+v));
            const cx = canvas.width/2, cy = canvas.height/2;
            panX = cx - (cx - panX)*(newScale/scale);
            panY = cy - (cy - panY)*(newScale/scale);
            scale = newScale; 
            draw(); 
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#e5e7eb"; ctx.fillRect(0,0, canvas.width, canvas.height); // ë°°ê²½ìƒ‰

            ctx.save();
            ctx.translate(panX, panY); 
            ctx.scale(scale, scale);
            
            if(isBgLoaded) {
                ctx.shadowColor="rgba(0,0,0,0.1)"; ctx.shadowBlur=20;
                ctx.drawImage(bgImage, 0, 0);
                ctx.shadowBlur=0;
            }

            // ê·¸ë¦¬ê¸° (ëª¨ë“  ì¢Œí‘œëŠ” ì´ë¯¸ì§€ ê¸°ì¤€)
            items.forEach(it => {
                // ì—°ê²°ì„ 
                ctx.beginPath(); ctx.moveTo(it.dx, it.dy); ctx.lineTo(it.bx+it.bw/2, it.by+it.bh/2);
                ctx.strokeStyle = it.col; ctx.lineWidth = 2/scale; ctx.setLineDash([5,3]); ctx.stroke(); ctx.setLineDash([]);

                // ì 
                ctx.beginPath(); ctx.arc(it.dx, it.dy, 8/scale, 0, Math.PI*2);
                ctx.fillStyle = "rgba(239, 68, 68, 0.9)"; ctx.fill(); 
                ctx.strokeStyle = "white"; ctx.lineWidth = 2/scale; ctx.stroke();

                // ë°•ìŠ¤
                ctx.fillStyle="rgba(255,255,255,0.95)"; 
                ctx.shadowColor="rgba(0,0,0,0.2)"; ctx.shadowBlur=5/scale; ctx.shadowOffsetY=3/scale;
                ctx.fillRect(it.bx, it.by, it.bw, it.bh);
                
                ctx.shadowColor="transparent";
                ctx.strokeStyle = (selectedIdx===it.id) ? "#ef4444" : it.col; 
                ctx.lineWidth = 2/scale; 
                ctx.strokeRect(it.bx, it.by, it.bw, it.bh);

                // í…ìŠ¤íŠ¸ (Scaleì— ë”°ë¼ ê¹¨ì§€ì§€ ì•Šê²Œ ë³´ì • í•„ìš”í•˜ì§€ë§Œ, ê°„ë‹¨í•˜ê²Œ ì²˜ë¦¬)
                // í…ìŠ¤íŠ¸ í¬ê¸°ë„ ì¤Œì— ë”°ë¼ ê°™ì´ ì»¤ì ¸ì•¼ í•¨ (ì´ë¯¸ì§€ ì¢Œí‘œê³„ì´ë¯€ë¡œ)
                ctx.fillStyle=it.col; ctx.font=`bold 15px Pretendard`; ctx.fillText(it.loc, it.bx+10, it.by+25);
                ctx.fillStyle="#666"; ctx.font=`13px Pretendard`; ctx.fillText(it.size, it.bx+10, it.by+48);
            });

            ctx.restore();
            
            // í™”ë©´ìƒ ì›Œí„°ë§ˆí¬ (ì €ì¥ìš© ì•„ë‹˜)
            ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.font = "bold 14px Pretendard"; 
            ctx.fillText("PREVIEW MODE", 20, canvas.height - 20);
        }

        // --- ë§ˆìš°ìŠ¤ ì¸í„°ë™ì…˜ (ì¢Œí‘œê³„ ë³€í™˜ í•„ìˆ˜) ---
        function getPos(e) { const r = canvas.getBoundingClientRect(); return { x: e.clientX-r.left, y: e.clientY-r.top }; }
        
        // í™”ë©´ ì¢Œí‘œ(Screen) -> ì´ë¯¸ì§€ ì¢Œí‘œ(World) ë³€í™˜
        function toWorld(sx, sy) { return { x: (sx - panX)/scale, y: (sy - panY)/scale }; }

        canvas.addEventListener('mousedown', e => {
            const p = getPos(e); const wp = toWorld(p.x, p.y);
            lastX = p.x; lastY = p.y;
            
            // ì—­ìˆœ ì²´í¬
            for(let i=items.length-1; i>=0; i--) {
                const it=items[i];
                // ë°•ìŠ¤ ì²´í¬ (World ì¢Œí‘œê³„)
                if(wp.x>=it.bx && wp.x<=it.bx+it.bw && wp.y>=it.by && wp.y<=it.by+it.bh) { dragTarget='box'; selectedIdx=it.id; items.push(items.splice(i,1)[0]); draw(); return; }
                // ì  ì²´í¬
                if(Math.sqrt((wp.x-it.dx)**2 + (wp.y-it.dy)**2) < 15/scale) { dragTarget='dot'; selectedIdx=it.id; items.push(items.splice(i,1)[0]); draw(); return; }
            }
            dragTarget='map'; selectedIdx=-1; draw();
        });

        canvas.addEventListener('mousemove', e => {
            if(!dragTarget) return;
            const p = getPos(e); 
            // ì´ë™ëŸ‰(Delta)ì„ Scaleë¡œ ë‚˜ëˆ„ì–´ì•¼ ì´ë¯¸ì§€ìƒì—ì„œì˜ ì´ë™ê±°ë¦¬ê°€ ë¨
            const dx = (p.x - lastX) / scale; 
            const dy = (p.y - lastY) / scale;
            
            // ë§µ ì´ë™ì€ í™”ë©´ ì¢Œí‘œê³„ ê¸°ì¤€
            if(dragTarget==='map') { panX += (p.x - lastX); panY += (p.y - lastY); }
            else {
                const cur = items[items.length-1];
                if(dragTarget==='box') { cur.bx += dx; cur.by += dy; }
                else if(dragTarget==='dot') { cur.dx += dx; cur.dy += dy; }
            }
            lastX = p.x; lastY = p.y; draw();
        });

        canvas.addEventListener('mouseup', () => dragTarget=null);
        canvas.addEventListener('wheel', e => { e.preventDefault(); zoom(e.deltaY>0?-0.1:0.1); }, {passive:false});


        // â˜…â˜…â˜… í•µì‹¬: ê³ í™”ì§ˆ ë„ë©´ ì €ì¥ (Footer í¬í•¨) â˜…â˜…â˜…
        function downloadHighResImage() {
            if(!isBgLoaded) return alert("ë„ë©´ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
            
            const cName = document.getElementById('consultantName').value || "ìƒë‹´ì‚¬";
            const cPhone = document.getElementById('consultantPhone').value || "";
            
            // 1. ì„ì‹œ ìº”ë²„ìŠ¤ ìƒì„± (ì´ë¯¸ì§€ ì›ë³¸ í¬ê¸° + í•˜ë‹¨ Footer ê³µê°„)
            const tempCanvas = document.createElement('canvas');
            const tCtx = tempCanvas.getContext('2d');
            const footerH = 100; // í•˜ë‹¨ ë°” ë†’ì´
            
            tempCanvas.width = bgImage.width;
            tempCanvas.height = bgImage.height + footerH;
            
            // 2. ë°°ê²½ ê·¸ë¦¬ê¸°
            tCtx.fillStyle = "white"; tCtx.fillRect(0,0, tempCanvas.width, tempCanvas.height);
            tCtx.drawImage(bgImage, 0, 0);
            
            // 3. ì•„ì´í…œ ê·¸ë¦¬ê¸° (ì´ë¯¸ ì¢Œí‘œê°€ ì´ë¯¸ì§€ ê¸°ì¤€ì´ë¯€ë¡œ Scale=1ë¡œ ê·¸ë¦¬ë©´ ë¨)
            items.forEach(it => {
                // ì—°ê²°ì„ 
                tCtx.beginPath(); tCtx.moveTo(it.dx, it.dy); tCtx.lineTo(it.bx+it.bw/2, it.by+it.bh/2);
                tCtx.strokeStyle = it.col; tCtx.lineWidth = 3; tCtx.setLineDash([8,5]); tCtx.stroke(); tCtx.setLineDash([]);

                // ì 
                tCtx.beginPath(); tCtx.arc(it.dx, it.dy, 12, 0, Math.PI*2);
                tCtx.fillStyle = "red"; tCtx.fill(); tCtx.strokeStyle="white"; tCtx.lineWidth=3; tCtx.stroke();

                // ë°•ìŠ¤
                tCtx.fillStyle = "rgba(255,255,255,0.95)";
                tCtx.fillRect(it.bx, it.by, it.bw, it.bh);
                tCtx.strokeStyle = it.col; tCtx.lineWidth = 3; tCtx.strokeRect(it.bx, it.by, it.bw, it.bh);

                // í…ìŠ¤íŠ¸ (ê³ í™”ì§ˆìš© í°íŠ¸ í¬ê¸° ì¡°ì • í•„ìš”ì—†ìŒ, 1:1 ë§¤ì¹­)
                tCtx.fillStyle = it.col; tCtx.font = "bold 20px sans-serif"; tCtx.fillText(it.loc, it.bx+15, it.by+35);
                tCtx.fillStyle = "#555"; tCtx.font = "18px sans-serif"; tCtx.fillText(it.size, it.bx+15, it.by+65);
            });

            // 4. Footer (ë¡œê³  & ìƒë‹´ì‚¬ ì •ë³´) ê·¸ë¦¬ê¸°
            const fy = bgImage.height; // footer ì‹œì‘ Yì¢Œí‘œ
            tCtx.fillStyle = "#1e3a8a"; // KCC Blue
            tCtx.fillRect(0, fy, tempCanvas.width, footerH);
            
            // ë¡œê³  í…ìŠ¤íŠ¸
            tCtx.fillStyle = "white";
            tCtx.font = "bold 40px sans-serif";
            tCtx.fillText("KCC GLASS", 30, fy + 65);
            
            // êµ¬ë¶„ì„ 
            tCtx.strokeStyle = "rgba(255,255,255,0.3)"; tCtx.lineWidth = 2;
            tCtx.beginPath(); tCtx.moveTo(280, fy+20); tCtx.lineTo(280, fy+80); tCtx.stroke();

            // ìƒë‹´ì‚¬ ì •ë³´
            tCtx.textAlign = "right";
            tCtx.fillStyle = "white";
            tCtx.font = "bold 24px sans-serif";
            tCtx.fillText(`ë‹´ë‹¹: ${cName}`, tempCanvas.width - 40, fy + 40);
            tCtx.font = "20px sans-serif";
            tCtx.fillText(`ğŸ“ ${cPhone}`, tempCanvas.width - 40, fy + 75);

            // 5. ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
            const link = document.createElement('a');
            link.download = `KCC_ì„¤ê³„ë„ë©´_${cName}.png`;
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>